// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id             String          @id @default(cuid())
  sellerId       String          @unique
  nickname       String?
  siteId         String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  tokens         AccountToken[]
  items          Item[]
  orders         Order[]
  shipments      Shipment[]
  questions      Question[]
  messages       Message[]
  settings       Settings?
  billingPeriods BillingPeriod[]
  expenses       Expense[]
  extraRevenues  ExtraRevenue[]
  taxes          Tax[]
}

model AccountToken {
  id           String   @id @default(cuid())
  accountId    String
  accessToken  String
  refreshToken String
  tokenType    String?
  scope        String?
  expiresIn    Int
  obtainedAt   DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}

model Item {
  id          String   @id @default(cuid())
  accountId   String
  meliItemId  String   @unique
  title       String
  status      String
  price       Float
  available   Int
  sold        Int      @default(0)
  thumbnail   String?
  picture     String?  // Imagem em alta resolução
  permalink   String?  // Link do anúncio no ML
  has_bids    Boolean  @default(false) // Indica se o item possui lances ativos
  buying_mode String?  // Modo de compra (buy_it_now, auction, etc)
  listing_type_id String? // Tipo de listagem (bronze, silver, gold, etc)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
}

model Order {
  id            String   @id @default(cuid())
  accountId     String
  meliOrderId   String   @unique
  status        String
  totalAmount   Float
  dateCreated   DateTime
  buyerId       String?
  buyerNickname String?  // Nome do comprador
  itemId        String?  // ID do produto
  itemTitle     String?  // Título do produto
  itemPermalink String?  // Link do anúncio
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([dateCreated])
}

model Shipment {
  id              String   @id @default(cuid())
  accountId       String
  meliShipmentId  String   @unique
  orderId         String?  // Relacionamento com Order
  mode            String   // me2, me1, custom, etc.
  status          String   // pending, ready_to_ship, shipped, delivered, etc.
  substatus       String?
  trackingNumber  String?
  trackingMethod  String?
  estimatedDelivery DateTime?
  shippedDate     DateTime?
  deliveredDate   DateTime?
  receiverAddress String?  // JSON com endereço completo
  senderAddress   String?  // JSON com endereço completo
  cost            Float?
  // SLA - Prazo de despacho
  slaStatus       String?  // on_time, delayed
  slaService      String?  // xd_same_day, next_day, standard
  slaExpectedDate DateTime? // Data limite para despacho
  slaLastUpdated  DateTime?
  // Lead Time - Prazos de entrega
  handlingLimit   DateTime? // Prazo para despachar
  deliveryLimit   DateTime? // Prazo para entregar
  deliveryFinal   DateTime? // Prazo final
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([orderId])
  @@index([status])
  @@index([slaExpectedDate])
  @@index([slaStatus])
}

model Question {
  id             String   @id @default(cuid())
  accountId      String
  meliQuestionId String   @unique
  itemId         String?  // Relacionamento com Item
  text           String
  status         String   // UNANSWERED, ANSWERED, CLOSED_UNANSWERED, UNDER_REVIEW, BANNED, DELETED
  answer         String?
  dateCreated    DateTime
  dateAnswered   DateTime?
  fromId         String   // ID do comprador
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([itemId])
  @@index([status])
  @@index([dateCreated])
}

model Message {
  id              String   @id @default(cuid())
  accountId       String
  meliMessageId   String   @unique
  packId          String?  // ID do pacote de mensagens (conversa)
  orderId         String?  // Relacionamento com Order
  itemId          String?  // Relacionamento com Item
  fromId          String   // ID do remetente
  toId            String   // ID do destinatário
  fromRole        String   // buyer, seller
  toRole          String   // buyer, seller
  text            String   // Conteúdo da mensagem
  status          String   // read, unread
  dateCreated     DateTime
  dateRead        DateTime?
  dateNotified    DateTime?
  updatedAt       DateTime @updatedAt
  createdAt       DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([packId])
  @@index([orderId])
  @@index([status])
  @@index([dateCreated])
}

model WebhookEvent {
  id          String   @id @default(cuid())
  eventId     String   @unique // _id do webhook do ML
  topic       String   // orders, items, questions, etc.
  resource    String   // URL do recurso
  userId      String   // seller_id
  payload     Json     // payload completo
  processed   Boolean  @default(false)
  receivedAt  DateTime @default(now())
  processedAt DateTime?

  @@index([topic])
  @@index([processed])
  @@index([userId])
  @@index([receivedAt])
}

model Settings {
  id        String   @id @default(cuid())
  accountId String   @unique
  
  // Sincronização
  syncInterval       Int      @default(30) // minutos
  syncItems          Boolean  @default(true)
  syncOrders         Boolean  @default(true)
  syncQuestions      Boolean  @default(true)
  syncHistoryDays    Int      @default(30)
  
  // Notificações
  notificationsEnabled       Boolean @default(true)
  notifyNewQuestions         Boolean @default(true)
  notifyNewOrders            Boolean @default(true)
  notifyLowStock             Boolean @default(true)
  notifyQuestionsSLA         Boolean @default(true)
  
  // Preferências
  theme              String   @default("system") // light, dark, system
  language           String   @default("pt-BR")
  timezone           String   @default("America/Sao_Paulo")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId])
}

// Módulo Financeiro
model BillingPeriod {
  id                String   @id @default(cuid())
  accountId         String
  
  // Identificação do período
  periodKey         String   // Ex: "2024-06-01"
  dateFrom          DateTime
  dateTo            DateTime
  expirationDate    DateTime
  
  // Status
  periodStatus      String   // OPEN, CLOSED, PAID
  
  // Valores totais
  totalAmount       Float    @default(0) // Faturamento bruto
  unpaidAmount      Float    @default(0) // Valor não pago
  taxAmount         Float    @default(0) // Total de impostos
  feesAmount        Float    @default(0) // Total de taxas
  netAmount         Float    @default(0) // Faturamento líquido
  
  // Metadados
  rawData           Json?    // Dados brutos da API ML
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  account           Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  charges           BillingCharge[]
  payments          BillingPayment[]
  
  @@unique([accountId, periodKey])
  @@index([accountId])
  @@index([periodKey])
  @@index([periodStatus])
}

model BillingCharge {
  id                String   @id @default(cuid())
  periodId          String
  accountId         String
  
  // Tipo de cobrança
  chargeType        String   // SALE, FEE_ML, FEE_MP, TAX, BONUS, SHIPPING, OTHER
  category          String?  // Categoria específica (ex: "Comissão", "IVA", "IIBB")
  description       String   // Descrição da cobrança
  
  // Valores
  amount            Float
  
  // Referências
  referenceId       String?  // ID do pedido, item, etc
  referenceType     String?  // order, item, payment
  
  // Data
  chargeDate        DateTime
  
  // Metadados
  rawData           Json?    // Dados brutos da API ML
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  period            BillingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  
  @@index([periodId])
  @@index([accountId])
  @@index([chargeType])
  @@index([chargeDate])
}

// Pagamentos de Billing
model BillingPayment {
  id                        String   @id @default(cuid())
  periodId                  String
  accountId                 String
  
  // Identificação do pagamento
  paymentId                 String   // ID do pagamento no ML
  creditNoteNumber          String?  // Número da nota de crédito
  
  // Informações do pagamento
  paymentDate               DateTime
  paymentType               String   // collections_forced, manual, etc
  paymentTypeDescription    String?
  paymentMethod             String   // account_money, credit_card, etc
  paymentMethodDescription  String?
  paymentStatus             String   // approved, pending, rejected
  paymentStatusDescription  String?
  
  // Valores
  paymentAmount             Float    @default(0) // Valor total do pagamento
  amountInThisPeriod        Float    @default(0) // Valor aplicado neste período
  amountInOtherPeriod       Float    @default(0) // Valor aplicado em outro período
  remainingAmount           Float    @default(0) // Saldo a favor para próximas notas
  returnAmount              Float    @default(0) // Saldo a favor que o vendedor possui
  
  // Metadados
  rawData                   Json?    // Dados brutos da API ML
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  period                    BillingPeriod @relation(fields: [periodId], references: [id], onDelete: Cascade)
  
  @@unique([periodId, paymentId])
  @@index([accountId])
  @@index([paymentId])
  @@index([paymentDate])
  @@index([paymentStatus])
}

// Despesas Fixas
model Expense {
  id          String   @id @default(cuid())
  accountId   String
  
  // Informações da despesa
  name        String   // Ex: "Contador", "Aluguel"
  category    String   // CONTADOR, EMBALAGEM, ALUGUEL, MARKETING, FERRAMENTAS, OUTROS
  amount      Float    // Valor mensal
  description String?  // Descrição opcional
  
  // Recorrência
  isRecurring Boolean  @default(true) // Se é despesa recorrente
  startDate   DateTime @default(now()) // Data de início
  endDate     DateTime? // Data de fim (null = sem fim)
  
  // Status
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId])
  @@index([category])
  @@index([isActive])
}

// Receitas Extras
model ExtraRevenue {
  id          String   @id @default(cuid())
  accountId   String
  
  // Informações da receita
  name        String   // Ex: "Consultoria", "Serviços"
  category    String   // VENDA, CONSULTORIA, SERVICOS, COMISSAO, BONUS, OUTROS
  amount      Float    // Valor mensal
  description String?  // Descrição opcional
  
  // Recorrência
  isRecurring Boolean  @default(true) // Se é receita recorrente
  startDate   DateTime @default(now()) // Data de início
  endDate     DateTime? // Data de fim (null = sem fim)
  
  // Status
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId])
  @@index([category])
  @@index([isActive])
}

// Impostos e Taxas
model Tax {
  id          String   @id @default(cuid())
  accountId   String
  
  // Informações do imposto/taxa
  name        String   // Ex: "Simples Nacional", "Taxa ML"
  category    String   // SIMPLES_NACIONAL, TAXA_ML, TAXA_MP, OUTROS
  amount      Float    // Valor mensal
  description String?  // Descrição opcional
  
  // Recorrência
  isRecurring Boolean  @default(true) // Se é taxa recorrente
  startDate   DateTime @default(now()) // Data de início
  endDate     DateTime? // Data de fim (null = sem fim)
  
  // Status
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  account     Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  @@index([accountId])
  @@index([category])
  @@index([isActive])
}
